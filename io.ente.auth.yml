app-id: io.ente.auth
runtime: org.freedesktop.Platform
runtime-version: "23.08"
sdk: org.freedesktop.Sdk
command: ente_auth
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  # Flutter needs GPU permission.
  - --device=dri
  # Needs to talk to the network for authentication
  - --share=network
  # For desktop notifications
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
rename-appdata-file: ente_auth.appdata.xml
modules:
  - name: ente_auth
    buildsystem: simple
    build-commands:
      - install apply_extra ${FLATPAK_DEST}
      - mkdir ${FLATPAK_DEST}/bin ${FLATPAK_DEST}/lib
      - ARCH_TRIPLE=$(gcc --print-multiarch) && ln -s /usr/lib/${ARCH_TRIPLE}/libsqlite3.so.0 /app/lib/libsqlite3.so
      - ln -s ${FLATPAK_DEST}/share/ente_auth/ente_auth ${FLATPAK_DEST}/bin/ente_auth
    sources:
      - type: script
        commands:
          - bsdtar --to-stdout -xf ente-auth.deb data.* | bsdtar -xf -
          - mv usr/share .
          - rm -rf ente-auth.deb usr data.*
        dest-filename: apply_extra

      - type: extra-data
        only-arches:
          - x86_64
        url: https://github.com/ente-io/ente/releases/download/auth-v3.1.3/ente-auth-v3.1.3-x86_64.deb
        sha256: 03eaabcb14b2af781fb3feec4905b8695422294292546245252567b5500e242c
        size: 17251664
        filename: ente-auth.deb
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ente-io/ente/releases/latest
          version-query: '[.[].tag_name | select(startswith("auth-v"))] | sort_by(split("-v")[1:])[-1]'
          url-query: .[].assets[] | select(.name == "ente-auth-" + $version + "-x86_64.deb").browser_download_url
          is-main-source: true

  - auth-dependencies.yml
